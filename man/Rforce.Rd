% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/step3_Rforce.R
\name{Rforce}
\alias{Rforce}
\title{Fit a random forest for composite endpoints using CPIU-wide data}
\usage{
Rforce(
  data = NULL,
  formula = NULL,
  n_intervals = 10,
  weights_by_status = NULL,
  cpius = NULL,
  split_rule = c("Rforce-QLR", "Rforce-GEE", "Rforce-GEEIntr", "RF-SLAM"),
  n_trees = 300,
  mtry = NULL,
  n_splits = NULL,
  min_gain = NULL,
  min_node_size = NULL,
  max_depth = 8,
  n_threads = 4,
  seed = 926
)
}
\arguments{
\item{data}{Optional \code{data.frame} containing patient-level data.
Must include at least the patient ID, event time, and event status columns
referenced on the left-hand side of \code{formula}. Ignored if \code{cpius}
is supplied.}

\item{formula}{A \code{\link[survival]{Surv}} formula of the form
\code{Surv(id, time, status) ~ covariate_1 + covariate_2 + \dots}.
The left-hand side must contain three variables in order: patient ID,
follow-up time, and event status. If a character string is provided, it is
internally converted via \code{as.formula}. Used only when \code{cpius} is
\code{NULL}.}

\item{n_intervals}{Integer; number of follow-up intervals used to build the
CPIU-wide representation when \code{cpius} is not supplied. Defaults to
\code{10}. The default break points are based on empirical quantiles of the
follow-up time.}

\item{weights_by_status}{Optional numeric vector of non-negative weights, one
per unique event status in the original patient-level data (including
censoring). If supplied, its length must match the number of unique values
in the status variable. If \code{NULL}, the default is weight 0 for
censoring (status = 0) and weight 1 for all event types.}

\item{cpius}{Optional list containing pre-computed CPIU-wide data, typically
the output of \code{\link{patients_to_cpius}} (optionally processed by
\code{\link{cpius_to_dummy}}). It is expected to contain at least:
\itemize{
\item \code{design_matrix_Y}: numeric matrix of CPIU-wide outcomes and covariates;
\item \code{auxiliary_features}: numeric matrix of auxiliary CPIU-level
features (e.g., pseudo–at-risk durations, event indicators, weights)
aligned with \code{design_matrix_Y};
\item \code{variableIds}: integer vector of group IDs for dummy-encoded
covariates;
\item \code{unitsOfCPIUs}: numeric vector giving interval widths;
\item \code{isDummy}: logical flag indicating whether covariates are
already dummy-encoded.
}
If \code{cpius} is supplied, the internal data-to-CPIU conversion step is
skipped.}

\item{split_rule}{Character string specifying the splitting rule:
\itemize{
\item \code{"Rforce-QLR"} — quasi-likelihood ratio–based splitting;
\item \code{"Rforce-GEE"} — GEE-based splitting without interaction;
\item \code{"Rforce-GEEIntr"} — GEE-based splitting with interaction;
\item \code{"RF-SLAM"} — RF-SLAM–style splitting without pseudo–at-risk
durations.
}
Partial matching is not supported; the value must match one of these
strings exactly.}

\item{n_trees}{Integer; number of trees in the forest. Default is \code{300}.}

\item{mtry}{Integer; number of candidate variables drawn at random at each
split. If \code{NULL}, a default is chosen internally based on the number
of covariates.}

\item{n_splits}{Integer; number of candidate split points considered per
variable at each node. If \code{NULL}, a default is chosen internally.}

\item{min_gain}{Numeric; minimum improvement in the split criterion required
to accept a split. For \code{"Rforce-QLR"} and \code{"RF-SLAM"} this is
interpreted as the percentage of quasi-likelihood increase (e.g. default
\code{0.01} corresponds to 1\\%). For \code{"Rforce-GEE"} and
\code{"Rforce-GEEIntr"}, it is treated as a threshold on an adjusted
\eqn{p}-value (e.g. default 0.2).}

\item{min_node_size}{Integer; minimum number of patients required in a
terminal node (or to attempt further splitting). If \code{NULL}, a default
is chosen internally based on the sample size.}

\item{max_depth}{Integer; maximum depth of each tree. Use \code{NULL} or a
large value to allow essentially full growth, subject to \code{min_node_size}
and \code{min_gain}. The default is \code{8}.}

\item{n_threads}{Integer; number of threads to use for OpenMP parallel computation,
if supported by the system. The default is \code{4}.}

\item{seed}{Integer random seed used to initialize the C back end for
reproducible forests. Defaults to \code{926}.}
}
\value{
An object of class \code{"Rforce"}, a list with elements including (but not
limited to):
\itemize{
\item \code{cpius} — the CPIU-wide list containing \code{design_matrix_Y},
\code{auxiliary_features}, \code{variableIds}, \code{unitsOfCPIUs},
and related meta-data;
\item \code{bagMatrix} — bootstrap sample indicators for each tree;
\item \code{treePhi} — estimates of the mean structure for each interval in
each tree;
\item \code{forestMatrix} — a compact summary of the forest structure
in matrix form (not intended to be interpreted directly by users);
\item \code{vimpStat} — forest structure and variable importance summaries
returned from the C back end;
\item \code{predicted}, \code{oobPredicted} — fitted and out-of-bag
predictions on the CPIU scale;
\item hyperparameters such as \code{nTrees}, \code{maxDepth},
\code{minNodeSize}, \code{minGain}, \code{mtry}, \code{nsplits},
and \code{seed};
\item \code{_external_forest_C_Ptr} — an external pointer storing the
forest from the Rforce C API. It is valid only for the current R
session unless serialized and restored via \code{\link{saveRforce}}
and \code{\link{loadRforce}}.
}
}
\description{
\code{Rforce()} fits a random forest model for composite endpoints—including
recurrent non-fatal events and a terminal event—using the CPIU (composite
pseudo–at-risk interval)–wide representation as the working data structure.

The function can either:
\itemize{
\item take raw patient-level long-formatted \code{data} and a
\code{Surv(id, time, status) ~ covariates} \code{formula}, internally
construct the CPIU-wide design matrix and auxiliary features, and then
fit the forest; or
\item directly accept a pre-computed \code{cpius} object (typically created
by \code{\link{patients_to_cpius}} and \code{\link{cpius_to_dummy}})
that already contains the CPIU-wide matrices and meta-data.
}
}
\details{
When \code{cpius} is \code{NULL}, \code{Rforce()}:
\enumerate{
\item checks that \code{data} and \code{formula} are supplied and that the
left-hand side of \code{formula} is of the form
\code{Surv(id, time, status)};
\item validates that all variables appearing on the left- and right-hand
sides of \code{formula} are present in \code{data};
\item computes CPIU interval widths from the empirical distribution of the
follow-up time using \code{n_intervals} empirical quantiles;
\item constructs a long-format working dataset combining covariates and the
\code{Id}, \code{X}, and \code{Status} response variables;
\item calls \code{\link{patients_to_cpius}} to build a CPIU-wide design
matrix and auxiliary features, with pseudo–at-risk durations used for
\code{"Rforce-QLR"}, \code{"Rforce-GEE"}, and
\code{"Rforce-GEEIntr"}, and disabled for \code{"RF-SLAM"};
\item applies \code{\link{cpius_to_dummy}} to dummy-encode factor and
character covariates if they are not already dummy-encoded;
\item passes the resulting CPIU-wide matrices, variable grouping, and
interval widths to the C routine \code{R_Rforce}, together with the
specified splitting rule and hyperparameters.
}

The fitted forest is returned as an S3 object of class \code{"Rforce"} with
components including the CPIU-wide data structure, forest structure, and
out-of-bag predictions, along with various meta-data to facilitate downstream
methods such as \code{print.Rforce()}, \code{summary.Rforce()}, and
\code{predict.Rforce()}.
}
\examples{
## Example using simulated data
library(Rforce)

set.seed(926)

data_list <- compo_sim()

df_censored <- random_censoring(
  data       = data_list$dataset,
  event_rate = 0.5
)

fit <- Rforce(
  data         = df_censored,
  formula      = Surv(Id, X, Status) ~ .,
  n_intervals  = 5,
  n_trees      = 50,
  max_depth    = 10,
  min_node_size = 20,
  min_gain     = 0,
  mtry         = 2,
  n_splits     = 5
)

fit

}
\seealso{
\code{\link{compo_sim}},
\code{\link{random_censoring}},
\code{\link{patients_to_cpius}},
\code{\link{cpius_to_dummy}},
\code{\link[survival]{Surv}},
\code{\link{predict.Rforce}},
\code{\link{summary.Rforce}},
\code{\link{vimp.Rforce}},
\code{\link{saveRforce}},
\code{\link{loadRforce}}.
}
